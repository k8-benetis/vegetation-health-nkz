server {
    listen 80;
    server_name _;
    root /usr/share/nginx/html;
    index index.html;
    
    # CORS headers for Module Federation
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;
    
    # Handle preflight requests
    if ($request_method = OPTIONS) {
        return 204;
    }
    
    # Health check endpoint
    # Handle /modules/vegetation-prime prefix (from ingress)
    location ~ ^/modules/vegetation-prime/(.*)$ {
        set $path $1;
        rewrite ^/modules/vegetation-prime/(.*)$ /$1 break;
        root /usr/share/nginx/html;
        
        # CORS headers
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;

        # Default: Long cache for hashed assets (js, css, png, etc)
        expires 1y;
        add_header Cache-Control "public, max-age=31536000, immutable";
        
        # Override: Short cache for remoteEntry.js (critical for updates)
        if ($path ~* remoteEntry\.js$) {
            expires 60s;
            add_header Cache-Control "public, max-age=60, must-revalidate";
        }
        
        # Override: No cache for index.html/manifest.json
        if ($path ~* (index\.html|manifest\.json)$) {
            expires -1;
            add_header Cache-Control "no-store, no-cache, must-revalidate";
        }

        try_files $uri $uri/ /index.html;
    }

    # Explicitly serve manifest.json to avoid SPA router capture
    location = /modules/vegetation-prime/manifest.json {
        alias /usr/share/nginx/html/manifest.json;
        add_header Access-Control-Allow-Origin * always;
        add_header Content-Type application/json;
        add_header Cache-Control "no-store, no-cache, must-revalidate";
    }

    
    # Internal location for health check
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
    
    # Fallback for root access (dev/testing)
    location / {
        try_files $uri $uri/ /index.html;
    }
}
